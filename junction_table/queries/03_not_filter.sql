-- ============================================
-- NOT フィルタ: 「乳製品」タグが付いていない商品（アレルギー除外）
-- ============================================
--
-- やりたいこと:
--   乳製品アレルギーの人が食べられる商品だけを取得する
--
-- 仕組み:
--   NOT EXISTS サブクエリで、
--   「この商品に '乳製品' タグが付いている行が存在しない」ことを条件にする。
--
-- ポイント:
--   中間テーブルがなければ、products テーブルに「乳製品フラグ」などの
--   カラムを追加する必要がある。アレルギー項目が増えるたびにカラムが増えてしまう。
--   中間テーブルなら、タグを追加するだけで対応できる。
-- ============================================

SELECT
    p.id,
    p.name,
    p.price
FROM products p
WHERE NOT EXISTS (
    SELECT 1
    FROM product_tags pt
    JOIN tags t ON pt.tag_id = t.id
    WHERE pt.product_id = p.id
      AND t.name = '乳製品'
)
ORDER BY p.id;
